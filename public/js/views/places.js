// Generated by CoffeeScript 1.12.7
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  define(['jquery', 'backbone', 'collections/places', 'utils', 'views/container', 'views/confirm', 'text!templates/places.ejs', 'data', 'table'], function($, B, Collection, U, ContainerView, ConfirmView, temp, Data) {
    var View, columns, root_columms;
    columns = [
      {
        field: 'name',
        title: '场地方',
        sortable: true
      }, {
        field: 'address',
        title: '地理位置',
        sortable: true
      }, {
        field: 'deviceStatus',
        title: '设备状态(正常/总数)',
        sortable: true
      }, {
        field: 'today',
        title: '今日流水',
        sortable: true
      }, {
        field: 'yestoday',
        title: '昨日流水',
        sortable: true
      }, {
        field: 'thisWeek',
        title: '本周流水',
        sortable: true
      }, {
        field: 'lastWeek',
        title: '上周流水',
        sortable: true
      }, {
        field: 'deviceStatus',
        title: '设备状态(正常/总数)',
        sortable: true
      }, {
        field: 'reconciliation',
        title: '对账'
      }
    ];
    root_columms = [
      {
        field: 'edit',
        title: '编辑'
      }, {
        field: 'delete',
        title: '删除'
      }
    ];
    return View = (function(superClass) {
      extend(View, superClass);

      function View() {
        return View.__super__.constructor.apply(this, arguments);
      }

      View.prototype.initialize = function() {
        this._filter = {};
        this.collection = new Collection();
        this.columns = columns.slice();
        if (Data.isRoot()) {
          this.columns = this.columns.concat(root_columms);
        }
        this.render();
        this.fetch();
        return this;
      };

      View.prototype.events = {
        'click .selector': 'onSelect'
      };

      View.prototype.render = function() {
        this.$el.html(ejs.render(temp));
        this.$table = this.$el.find('#placesTable');
        this.$container = this.$el.find('#seletorContainer');
        this.$table.bootstrapTable({
          columns: this.columns,
          striped: true,
          pagination: true,
          pageSize: 50,
          search: true,
          onClickCell: function(field, val, obj) {
            var view;
            if (field === 'deviceStatus') {
              return Data.app.navigate('/devices?_placeId=' + obj._id, {
                trigger: true
              });
            } else if (field === 'reconciliation') {
              return Data.app.navigate('/reconciliation?_placeId=' + obj._id, {
                trigger: true
              });
            } else if (field === 'edit') {
              return Data.app.navigate('/placesEdit?_placeId=' + obj._id, {
                trigger: true
              });
            } else if (field === 'delete') {
              view = new ConfirmView({
                title: '删除确认',
                content: '是否确认删除该场地?',
                onConfirm: function() {
                  Data.del('place', obj._id);
                  return view.close();
                },
                onCancel: function() {
                  return view.close();
                }
              });
              return $('body').append(view.$el);
            }
          }
        });
        return this;
      };

      View.prototype.renderPlaces = function(places) {
        places || (places = this.collection.models.map(function(place) {
          return place.parse(place.toJSON());
        }));
        return this.$table.bootstrapTable('load', places);
      };

      View.prototype.fetch = function() {
        var self;
        self = this;
        return $.ajax({
          url: '/api/places/statistic',
          json: true
        }).done((function(_this) {
          return function(places) {
            _this.collection.add(places);
            return _this.renderPlaces();
          };
        })(this)).fail(function(err) {
          return console.log(err);
        });
      };

      View.prototype.onSelect = function(e) {
        var $target, f, id, val;
        $target = $(e.target);
        id = $target.data('id');
        val = $target.html();
        f = {};
        f[id] = val;
        return this.filter(f);
      };

      return View;

    })(B.View);
  });

}).call(this);
